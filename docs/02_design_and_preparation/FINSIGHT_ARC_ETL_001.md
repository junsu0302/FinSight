| 문서 ID       | FINSIGHT-ARC-ETL-001 |
| :------------ | :------------------- |
| **문서 버전** | 1.0                  |
| **프로젝트**  | FinSight             |
| **작성자**    | 김준수               |
| **작성일**    | 2025년 9월 10일      |

## 1. 문서 개요

본 문서는 FinSight 프로젝트의 데이터 수집 파이프라인의 핵심 구성요소인 **한국투자증권(KIS) API 연동 모듈(`KIS_API_hook.py`)** 의 소프트웨어 아키텍처를 상세히 기술하는 것을 목적으로 한다.

본 설계서는 모듈의 요구사항, 전체 구조, 적용된 디자인 패턴, 핵심 로직을 명세하여 향후 개발 및 유지보수 담당자가 설계 사상을 명확히 이해하고 일관된 개발을 수행할 수 있도록 지원한다.

---

## 2. 요구사항 및 제약사항

### 2.1. 기능 요구사항

- **데이터 조회 통합**: KIS API가 제공하는 다양한 금융 데이터(기본 정보, 재무제표, 시세 등)를 단일화된 인터페이스를 통해 조회할 수 있어야 한다.
- **자동 인증 처리**: API 호출에 필요한 접근 토큰(Access Token)의 발급, 캐싱, 갱신 절차를 내부적으로 자동 처리하여 사용자는 인증 과정을 신경 쓰지 않아도 돼야 한다.
- **일관된 결과 반환**: KIS API의 엔드포인트마다 다른 응답 구조(`output`, `output1` 등)를 정규화하여 일관된 형식의 데이터(List[Dict])로 반환해야 한다.

### 2.2. 비기능 요구사항

- **유지보수성**: 향후 KIS API의 명세가 변경되거나 신규 API가 추가될 경우, 최소한의 코드 수정으로 대응할 수 있는 확장 가능한 구조여야 한다.
- **신뢰성**: 일시적인 네트워크 오류나 API 서버의 응답 지연에 대응할 수 있는 재시도(Retry) 및 예외 처리 로직을 포함해야 한다.
- **성능**: 불필요한 API 인증 요청을 최소화하기 위해 효율적인 토큰 캐싱(Caching) 전략을 사용해야 한다.
- **테스트 용이성**: 외부 API 및 환경에 대한 의존성을 분리하여 단위 테스트(Unit Test)가 가능한 구조를 지향해야 한다.

---

## 3. 아키텍처 및 설계

`KIS_API_hook` 모듈은 복잡한 외부 시스템과의 상호작용을 단순화하고 재사용성을 극대화하기 위해 **파사드(Facade)** 와 **템플릿 메서드(Template Method)** 디자인 패턴의 조합으로 설계되었다.

### 3.1. 전체 구조: 파사드(Facade) 패턴

`KISAPIHook` 클래스는 KIS API의 복잡한 서브시스템(인증, 개별 엔드포인트 등)에 대한 **단순하고 통일된 창구(Facade)** 역할을 수행한다. 이를 통해 모듈 사용자는 API의 내부 구현을 알 필요 없이, `hook.get_kr_stock_balance_sheet()`와 같은 직관적인 메서드 호출만으로 원하는 기능을 사용할 수 있다.

### 3.2. 내부 요청 로직: 템플릿 메서드(Template Method) 패턴

비공개 메서드 `_send_request`는 API 요청의 공통적인 알고리즘 골격(Skeleton)을 정의하는 **템플릿 메서드** 역할을 한다.

1.  **알고리즘 골격 (in `_send_request`)**:

    - `get_access_token()`: 유효한 토큰을 획득한다.
    - `headers`, `url` 구성: 공통 헤더와 URL을 조립한다.
    - `requests.get()`: 요청을 전송하고 재시도 로직을 수행한다.
    - 응답 검증: KIS API의 비즈니스 오류 코드(`rt_cd`)를 확인한다.
    - 결과 파싱: `output` 키로 시작하는 모든 결과를 동적으로 취합한다.

2.  **세부 구현 (in public methods)**:
    - `get_kr_stock_balance_sheet()`와 같은 각각의 공개 메서드들은 이 템플릿은 공유하면서, 자신에게 필요한 `path`, `tr_id`, `params`와 같은 세부 내용만 템플릿에 전달하는 방식으로 동작한다.

### 3.3. 설계 결정 및 대안 분석

본 설계는 여러 구조/행위 패턴과의 비교 분석을 통해 FinSight 프로젝트의 요구사항에 가장 적합한 조합으로 결정되었다.

#### 3.3.1. 전체 구조 패턴 비교

| 구분          | **채택: 파사드 (Facade)**                                                                                                                 | **대안: 어댑터 (Adapter)**                                                                                | **대안: 빌더 (Builder)**                                                                                                 |
| :------------ | :---------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------- |
| **핵심 목적** | 복잡한 서브시스템 **단순화**                                                                                                              | 비호환 인터페이스 **연결**                                                                                | 복잡한 객체 **생성**                                                                                                     |
| **평가**      | **(최적합)** 프로젝트의 주된 목표는 KIS API를 **쉽고 편하게 사용하는 것** 이므로, 복잡성을 감추는 파사드 패턴이 가장 직접적인 해결책이다. | (부적합) 기존에 정의된 다른 인터페이스에 맞춰야 할 요구사항이 없으므로, 어댑터 패턴을 사용할 이유가 없다. | (부적합) 수십 개의 API 호출 자체를 단순화하는 것이 문제이므로, 요청 객체 생성에 초점을 맞춘 빌더 패턴은 핵심을 벗어난다. |

#### 3.3.2. 내부 요청 로직 패턴 비교

| 구분          | **채택: 템플릿 메서드 (Template Method)**                                                                             | **대안: 스트래티지 (Strategy)**                                                                          | **대안: 커맨드 (Command)**                                                                                                      |
| :------------ | :-------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------ |
| **핵심 목적** | **고정된 알고리즘 골격** 내에서 일부 단계만 변경                                                                      | **알고리즘 전체**를 런타임에 교체                                                                        | 요청을 **객체로 캡슐화**하여 관리                                                                                               |
| **평가**      | **(최적합)** 모든 API 요청 절차가 **동일**하고 내용물만 바뀌므로, 이 절차를 템플릿으로 고정하는 것이 가장 효율적이다. | (과도한 설계) 요청 방식(전략)을 교체할 필요가 없으므로, 스트래티지 패턴은 필요 이상의 유연성을 제공한다. | (과도한 설계) 요청을 큐에 쌓거나 취소하는 기능이 필요 없는 상황에서, 각 호출마다 클래스를 만드는 것은 지나치게 복잡한 설계이다. |

---

## 4. 핵심 로직 상세

### 4.1. API 인증 토큰 관리

API 인증 요청 오버헤드를 최소화하기 위해 3계층 캐싱 전략을 사용한다.

- **1단계 (메모리 캐시)**: `_access_token` 속성에 저장된 토큰을 최우선으로 사용한다.
- **2단계 (파일 캐시)**: 메모리에 토큰이 없을 경우, 로컬 `kis_token.json` 파일에서 만료되지 않은 토큰을 읽어 사용한다.
- **3단계 (신규 발급)**: 메모리와 파일 캐시가 모두 유효하지 않을 때만 API 서버에 새로운 토큰을 요청하고, 그 결과를 메모리와 파일에 모두 저장한다.

### 4.2. API 요청 및 응답 처리

- **재시도 로직**: `_send_request` 메서드 내에서 네트워크 오류(`requests.exceptions.RequestException`) 발생 시, 최대 3회까지 1~2초의 간격을 두고 요청을 재시도하여 일시적인 장애에 대응한다.
- **동적 응답 파싱**: KIS API가 `output`, `output1` 등 가변적인 키로 결과를 반환하는 문제에 대응하기 위해, `response.json()`의 모든 키를 순회하며 `key.startswith('output')` 조건에 맞는 모든 데이터를 하나의 리스트로 병합하여 반환한다. 이는 향후 API 응답 구조 변경에 대한 유연성을 제공한다.
